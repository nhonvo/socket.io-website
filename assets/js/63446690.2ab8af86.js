"use strict";(self.webpackChunksample_website=self.webpackChunksample_website||[]).push([[241],{5680:(e,n,s)=>{s.d(n,{xA:()=>p,yg:()=>g});var t=s(6540);function o(e,n,s){return n in e?Object.defineProperty(e,n,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[n]=s,e}function r(e,n){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),s.push.apply(s,t)}return s}function a(e){for(var n=1;n<arguments.length;n++){var s=null!=arguments[n]?arguments[n]:{};n%2?r(Object(s),!0).forEach((function(n){o(e,n,s[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):r(Object(s)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))}))}return e}function i(e,n){if(null==e)return{};var s,t,o=function(e,n){if(null==e)return{};var s,t,o={},r=Object.keys(e);for(t=0;t<r.length;t++)s=r[t],n.indexOf(s)>=0||(o[s]=e[s]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(t=0;t<r.length;t++)s=r[t],n.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(e,s)&&(o[s]=e[s])}return o}var l=t.createContext({}),c=function(e){var n=t.useContext(l),s=n;return e&&(s="function"==typeof e?e(n):a(a({},n),e)),s},p=function(e){var n=c(e.components);return t.createElement(l.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},m=t.forwardRef((function(e,n){var s=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=c(s),m=o,g=u["".concat(l,".").concat(m)]||u[m]||d[m]||r;return s?t.createElement(g,a(a({ref:n},p),{},{components:s})):t.createElement(g,a({ref:n},p))}));function g(e,n){var s=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=s.length,a=new Array(r);a[0]=m;var i={};for(var l in n)hasOwnProperty.call(n,l)&&(i[l]=n[l]);i.originalType=e,i[u]="string"==typeof e?e:o,a[1]=i;for(var c=2;c<r;c++)a[c]=s[c];return t.createElement.apply(null,a)}return t.createElement.apply(null,s)}m.displayName="MDXCreateElement"},5893:(e,n,s)=>{s.r(n),s.d(n,{contentTitle:()=>l,default:()=>m,frontMatter:()=>i,metadata:()=>c,toc:()=>p});var t=s(8168),o=(s(6540),s(5680)),r=s(1470),a=s(9365);const i={title:"How to use with `express-session`"},l="How to use with express-session",c={type:"mdx",permalink:"/socket.io-website/how-to/use-with-express-session",source:"@site/src/pages/how-to/use-with-express-session.md",title:"How to use with `express-session`",description:"Let's start from a basic application:",frontMatter:{title:"How to use with `express-session`"}},p=[{value:"Sharing the session context",id:"sharing-the-session-context",level:2},{value:"Using the session ID",id:"using-the-session-id",level:2},{value:"Modifying the session",id:"modifying-the-session",level:2},{value:"Handling session expiration",id:"handling-session-expiration",level:2},{value:"Notes for cross-site requests",id:"notes-for-cross-site-requests",level:2}],u={toc:p},d="wrapper";function m(e){let{components:n,...s}=e;return(0,o.yg)(d,(0,t.A)({},u,s,{components:n,mdxType:"MDXLayout"}),(0,o.yg)("h1",{id:"how-to-use-with-express-session"},"How to use with ",(0,o.yg)("inlineCode",{parentName:"h1"},"express-session")),(0,o.yg)("p",null,"Let's start from a basic application:"),(0,o.yg)(r.A,{groupId:"lang",mdxType:"Tabs"},(0,o.yg)(a.A,{value:"cjs",label:"CommonJS",default:!0,mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'const express = require("express");\nconst { createServer } = require("node:http");\nconst { join } = require("node:path");\nconst { Server } = require("socket.io");\nconst session = require("express-session");\n\nconst port = process.env.PORT || 3000;\n\nconst app = express();\nconst httpServer = createServer(app);\n\nconst sessionMiddleware = session({\n  secret: "changeit",\n  resave: true,\n  saveUninitialized: true,\n});\n\napp.use(sessionMiddleware);\n\napp.get("/", (req, res) => {\n  res.sendFile(join(__dirname, "index.html"));\n});\n\napp.post("/incr", (req, res) => {\n  const session = req.session;\n  session.count = (session.count || 0) + 1;\n  res.status(200).end("" + session.count);\n});\n\nconst io = new Server(httpServer);\n\nhttpServer.listen(port, () => {\n  console.log(`application is running at: http://localhost:${port}`);\n});\n'))),(0,o.yg)(a.A,{value:"mjs",label:"ES modules",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'import express from "express";\nimport { createServer } from "node:http";\nimport { Server } from "socket.io";\nimport session from "express-session";\n\nconst port = process.env.PORT || 3000;\n\nconst app = express();\nconst httpServer = createServer(app);\n\nconst sessionMiddleware = session({\n  secret: "changeit",\n  resave: true,\n  saveUninitialized: true,\n});\n\napp.use(sessionMiddleware);\n\napp.get("/", (req, res) => {\n  res.sendFile(new URL("./index.html", import.meta.url).pathname);\n});\n\napp.post("/incr", (req, res) => {\n  const session = req.session;\n  session.count = (session.count || 0) + 1;\n  res.status(200).end("" + session.count);\n});\n\nconst io = new Server(httpServer);\n\nhttpServer.listen(port, () => {\n  console.log(`application is running at: http://localhost:${port}`);\n});\n'))),(0,o.yg)(a.A,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-ts"},'import express = require("express");\nimport { createServer } from "node:http";\nimport { Server } from "socket.io";\nimport session from "express-session";\n\ndeclare module "express-session" {\n  interface SessionData {\n    count: number;\n  }\n}\n\nconst port = process.env.PORT || 3000;\n\nconst app = express();\nconst httpServer = createServer(app);\n\nconst sessionMiddleware = session({\n  secret: "changeit",\n  resave: true,\n  saveUninitialized: true,\n});\n\napp.use(sessionMiddleware);\n\napp.get("/", (req, res) => {\n  res.sendFile(new URL("./index.html", import.meta.url).pathname);\n});\n\napp.post("/incr", (req, res) => {\n  const session = req.session;\n  session.count = (session.count || 0) + 1;\n  res.status(200).end("" + session.count);\n});\n\nconst io = new Server(httpServer);\n\nhttpServer.listen(port, () => {\n  console.log(`application is running at: http://localhost:${port}`);\n});\n')),(0,o.yg)("admonition",{type:"note"},(0,o.yg)("p",{parentName:"admonition"},"You'll need those additional types:"),(0,o.yg)("pre",{parentName:"admonition"},(0,o.yg)("code",{parentName:"pre"},"npm install @types/express @types/express-session\n"))))),(0,o.yg)("h2",{id:"sharing-the-session-context"},"Sharing the session context"),(0,o.yg)("p",null,"The session context can be shared with the Socket.IO server by calling:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"io.engine.use(sessionMiddleware);\n")),(0,o.yg)("p",null,"As simple as that! You'll now have access to the ",(0,o.yg)("inlineCode",{parentName:"p"},"session")," object:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'io.on("connection", (socket) => {\n  const session = socket.request.session;\n});\n')),(0,o.yg)("h2",{id:"using-the-session-id"},"Using the session ID"),(0,o.yg)("p",null,"You can use the session ID to make the link between Express and Socket.IO:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'io.on("connection", (socket) => {\n  const sessionId = socket.request.session.id;\n\n  // the session ID is used as a room\n  socket.join(sessionId);\n});\n')),(0,o.yg)("p",null,"You can then notify every connected client in the ",(0,o.yg)("inlineCode",{parentName:"p"},"/incr")," handler:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'app.post("/incr", (req, res) => {\n  const session = req.session;\n  session.count = (session.count || 0) + 1;\n  res.status(200).end("" + session.count);\n\n  // highlight-start\n  io.to(session.id).emit("current count", session.count);\n  // highlight-end\n});\n')),(0,o.yg)("p",null,"Same for the log-out flow:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'app.post("/logout", (req, res) => {\n  const sessionId = req.session.id;\n\n  req.session.destroy(() => {\n    // disconnect all Socket.IO connections linked to this session ID\n    // highlight-start\n    io.in(sessionId).disconnectSockets();\n    // highlight-end\n    res.status(204).end();\n  });\n});\n')),(0,o.yg)("h2",{id:"modifying-the-session"},"Modifying the session"),(0,o.yg)("p",null,"Since it is not bound to a single HTTP request, the session must be manually reloaded and saved:"),(0,o.yg)(r.A,{groupId:"lang",mdxType:"Tabs"},(0,o.yg)(a.A,{value:"cjs",label:"CommonJS",default:!0,mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'io.on("connection", (socket) => {\n  const req = socket.request;\n\n  socket.on("my event", () => {\n    req.session.reload((err) => {\n      if (err) {\n        return socket.disconnect();\n      }\n      req.session.count++;\n      req.session.save();\n    });\n  });\n});\n'))),(0,o.yg)(a.A,{value:"mjs",label:"ES modules",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'io.on("connection", (socket) => {\n  const req = socket.request;\n\n  socket.on("my event", () => {\n    req.session.reload((err) => {\n      if (err) {\n        return socket.disconnect();\n      }\n      req.session.count++;\n      req.session.save();\n    });\n  });\n});\n'))),(0,o.yg)(a.A,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-ts"},'import { type Request } from "express";\n\nio.on("connection", (socket) => {\n  const req = socket.request as Request;\n\n  socket.on("my event", () => {\n    req.session.reload((err) => {\n      if (err) {\n        return socket.disconnect();\n      }\n      req.session.count++;\n      req.session.save();\n    });\n  });\n});\n')))),(0,o.yg)("p",null,"You can also use a ",(0,o.yg)("a",{parentName:"p",href:"/docs/v4/server-api/#socketusefn"},"middleware")," which will be triggered for each incoming packet:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'io.on("connection", (socket) => {\n  const req = socket.request;\n\n  socket.use((__, next) => {\n    req.session.reload((err) => {\n      if (err) {\n        socket.disconnect();\n      } else {\n        next();\n      }\n    });\n  });\n\n  // and then simply\n  socket.on("my event", () => {\n    req.session.count++;\n    req.session.save();\n  });\n});\n')),(0,o.yg)("admonition",{type:"caution"},(0,o.yg)("p",{parentName:"admonition"},"Calling ",(0,o.yg)("inlineCode",{parentName:"p"},"req.session.reload()")," updates the ",(0,o.yg)("inlineCode",{parentName:"p"},"req.session")," object:"),(0,o.yg)("pre",{parentName:"admonition"},(0,o.yg)("code",{parentName:"pre",className:"language-js"},'io.on("connection", (socket) => {\n  const session = socket.request.session;\n\n  socket.use((__, next) => {\n    session.reload(() => {\n      // WARNING! "session" still points towards the previous session object\n    });\n  });\n});\n'))),(0,o.yg)("h2",{id:"handling-session-expiration"},"Handling session expiration"),(0,o.yg)("p",null,"You may also want to periodically reload the session, in case it expires (for example if the client does not send any event for an extended period of time):"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'const SESSION_RELOAD_INTERVAL = 30 * 1000;\n\nio.on("connection", (socket) => {\n  const timer = setInterval(() => {\n    socket.request.session.reload((err) => {\n      if (err) {\n        // forces the client to reconnect\n        socket.conn.close();\n        // you can also use socket.disconnect(), but in that case the client\n        // will not try to reconnect\n      }\n    });\n  }, SESSION_RELOAD_INTERVAL);\n\n  socket.on("disconnect", () => {\n    clearInterval(timer);\n  });\n});\n')),(0,o.yg)("h2",{id:"notes-for-cross-site-requests"},"Notes for cross-site requests"),(0,o.yg)("p",null,(0,o.yg)("inlineCode",{parentName:"p"},"express-session")," relies on a cookie to persist the session in the browser. So if your frontend domain is different from your backend domain (for example, if you have a SPA running on your machine but on a different port), then you will need to send the appropriate CORS headers:"),(0,o.yg)(r.A,{groupId:"lang",mdxType:"Tabs"},(0,o.yg)(a.A,{value:"cjs",label:"CommonJS",default:!0,mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'const cors = require("cors");\n    \nconst corsOptions = {\n  origin: ["http://localhost:4200"],\n  credentials: true\n};\n\n// for Express\napp.use(cors(corsOptions));\n\n// for Socket.IO\nconst io = new Server(httpServer, {\n  cors: corsOptions\n});\n'))),(0,o.yg)(a.A,{value:"mjs",label:"ES modules",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'import cors from "cors";\n    \nconst corsOptions = {\n  origin: ["http://localhost:4200"],\n  credentials: true\n};\n\n// for Express\napp.use(cors(corsOptions));\n\n// for Socket.IO\nconst io = new Server(httpServer, {\n  cors: corsOptions\n});\n'))),(0,o.yg)(a.A,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-ts"},'import cors = require("cors");\n    \nconst corsOptions = {\n  origin: ["http://localhost:4200"],\n  credentials: true\n};\n\n// for Express\napp.use(cors(corsOptions));\n\n// for Socket.IO\nconst io = new Server(httpServer, {\n  cors: corsOptions\n});\n')))),(0,o.yg)("p",null,"You will also need to set the ",(0,o.yg)("inlineCode",{parentName:"p"},"withCredentials")," option to ",(0,o.yg)("inlineCode",{parentName:"p"},"true")," on the client side:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},'import { io } from "socket.io-client";\n\nconst socket = io("http://localhost:3000", {\n  withCredentials: true\n});\n')),(0,o.yg)("p",null,"That's it for the compatibility with ",(0,o.yg)("inlineCode",{parentName:"p"},"express-session"),". Thanks for reading!"),(0,o.yg)("admonition",{type:"tip"},(0,o.yg)(r.A,{groupId:"lang",mdxType:"Tabs"},(0,o.yg)(a.A,{value:"cjs",label:"CommonJS",default:!0,attributes:{className:"display-none"},mdxType:"TabItem"},(0,o.yg)("p",{parentName:"admonition"},"You can run this example directly in your browser on:"),(0,o.yg)("ul",{parentName:"admonition"},(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("a",{parentName:"li",href:"https://codesandbox.io/p/sandbox/github/socketio/socket.io/tree/main/examples/express-session-example/cjs?file=index.js"},"CodeSandbox")),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("a",{parentName:"li",href:"https://stackblitz.com/github/socketio/socket.io/tree/main/examples/express-session-example/cjs?file=index.js"},"StackBlitz"))),"  "),(0,o.yg)(a.A,{value:"mjs",label:"ES modules",attributes:{className:"display-none"},mdxType:"TabItem"},(0,o.yg)("p",{parentName:"admonition"},"You can run this example directly in your browser on:"),(0,o.yg)("ul",{parentName:"admonition"},(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("a",{parentName:"li",href:"https://codesandbox.io/p/sandbox/github/socketio/socket.io/tree/main/examples/express-session-example/esm?file=index.js"},"CodeSandbox")),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("a",{parentName:"li",href:"https://stackblitz.com/github/socketio/socket.io/tree/main/examples/express-session-example/esm?file=index.js"},"StackBlitz"))),"  "),(0,o.yg)(a.A,{value:"ts",label:"TypeScript",attributes:{className:"display-none"},mdxType:"TabItem"},(0,o.yg)("p",{parentName:"admonition"},"You can run this example directly in your browser on:"),(0,o.yg)("ul",{parentName:"admonition"},(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("a",{parentName:"li",href:"https://codesandbox.io/p/sandbox/github/socketio/socket.io/tree/main/examples/express-session-example/ts?file=index.ts"},"CodeSandbox")),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("a",{parentName:"li",href:"https://stackblitz.com/github/socketio/socket.io/tree/main/examples/express-session-example/ts?file=index.ts"},"StackBlitz"))),"  "))))}m.isMDXComponent=!0},9365:(e,n,s)=>{s.d(n,{A:()=>a});var t=s(6540),o=s(53);const r={tabItem:"tabItem_Ymn6"};function a(e){let{children:n,hidden:s,className:a}=e;return t.createElement("div",{role:"tabpanel",className:(0,o.A)(r.tabItem,a),hidden:s},n)}},1470:(e,n,s)=>{s.d(n,{A:()=>N});var t=s(8168),o=s(6540),r=s(53),a=s(3104),i=s(6347),l=s(7485),c=s(1682),p=s(9466);function u(e){return function(e){return o.Children.map(e,(e=>{if(!e||(0,o.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:n,label:s,attributes:t,default:o}}=e;return{value:n,label:s,attributes:t,default:o}}))}function d(e){const{values:n,children:s}=e;return(0,o.useMemo)((()=>{const e=n??u(s);return function(e){const n=(0,c.X)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,s])}function m(e){let{value:n,tabValues:s}=e;return s.some((e=>e.value===n))}function g(e){let{queryString:n=!1,groupId:s}=e;const t=(0,i.W6)(),r=function(e){let{queryString:n=!1,groupId:s}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!s)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return s??null}({queryString:n,groupId:s});return[(0,l.aZ)(r),(0,o.useCallback)((e=>{if(!r)return;const n=new URLSearchParams(t.location.search);n.set(r,e),t.replace({...t.location,search:n.toString()})}),[r,t])]}function y(e){const{defaultValue:n,queryString:s=!1,groupId:t}=e,r=d(e),[a,i]=(0,o.useState)((()=>function(e){let{defaultValue:n,tabValues:s}=e;if(0===s.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!m({value:n,tabValues:s}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${s.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const t=s.find((e=>e.default))??s[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:r}))),[l,c]=g({queryString:s,groupId:t}),[u,y]=function(e){let{groupId:n}=e;const s=function(e){return e?`docusaurus.tab.${e}`:null}(n),[t,r]=(0,p.Dv)(s);return[t,(0,o.useCallback)((e=>{s&&r.set(e)}),[s,r])]}({groupId:t}),h=(()=>{const e=l??u;return m({value:e,tabValues:r})?e:null})();(0,o.useLayoutEffect)((()=>{h&&i(h)}),[h]);return{selectedValue:a,selectValue:(0,o.useCallback)((e=>{if(!m({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);i(e),c(e),y(e)}),[c,y,r]),tabValues:r}}var h=s(2303);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function b(e){let{className:n,block:s,selectedValue:i,selectValue:l,tabValues:c}=e;const p=[],{blockElementScrollPositionUntilNextRender:u}=(0,a.a_)(),d=e=>{const n=e.currentTarget,s=p.indexOf(n),t=c[s].value;t!==i&&(u(n),l(t))},m=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const s=p.indexOf(e.currentTarget)+1;n=p[s]??p[0];break}case"ArrowLeft":{const s=p.indexOf(e.currentTarget)-1;n=p[s]??p[p.length-1];break}}n?.focus()};return o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":s},n)},c.map((e=>{let{value:n,label:s,attributes:a}=e;return o.createElement("li",(0,t.A)({role:"tab",tabIndex:i===n?0:-1,"aria-selected":i===n,key:n,ref:e=>p.push(e),onKeyDown:m,onClick:d},a,{className:(0,r.A)("tabs__item",f.tabItem,a?.className,{"tabs__item--active":i===n})}),s??n)})))}function v(e){let{lazy:n,children:s,selectedValue:t}=e;const r=(Array.isArray(s)?s:[s]).filter(Boolean);if(n){const e=r.find((e=>e.props.value===t));return e?(0,o.cloneElement)(e,{className:"margin-top--md"}):null}return o.createElement("div",{className:"margin-top--md"},r.map(((e,n)=>(0,o.cloneElement)(e,{key:n,hidden:e.props.value!==t}))))}function x(e){const n=y(e);return o.createElement("div",{className:(0,r.A)("tabs-container",f.tabList)},o.createElement(b,(0,t.A)({},e,n)),o.createElement(v,(0,t.A)({},e,n)))}function N(e){const n=(0,h.A)();return o.createElement(x,(0,t.A)({key:String(n)},e))}}}]);