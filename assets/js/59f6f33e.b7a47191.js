"use strict";(self.webpackChunksample_website=self.webpackChunksample_website||[]).push([[8608],{5680:(e,n,t)=>{t.d(n,{xA:()=>s,yg:()=>c});var a=t(6540);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=a.createContext({}),g=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},s=function(e){var n=g(e.components);return a.createElement(p.Provider,{value:n},e.children)},d="mdxType",y={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,p=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),d=g(t),u=r,c=d["".concat(p,".").concat(u)]||d[u]||y[u]||l;return t?a.createElement(c,i(i({ref:n},s),{},{components:t})):a.createElement(c,i({ref:n},s))}));function c(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=u;var o={};for(var p in n)hasOwnProperty.call(n,p)&&(o[p]=n[p]);o.originalType=e,o[d]="string"==typeof e?e:r,i[1]=o;for(var g=2;g<l;g++)i[g]=t[g];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},3879:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>i,default:()=>y,frontMatter:()=>l,metadata:()=>o,toc:()=>g});var a=t(8168),r=(t(6540),t(5680));const l={title:"The Engine.IO protocol",sidebar_position:3,slug:"/engine-io-protocol/"},i=void 0,o={unversionedId:"categories/Miscellaneous/eio-protocol",id:"categories/Miscellaneous/eio-protocol",title:"The Engine.IO protocol",description:"This document describes the 4th version of the Engine.IO protocol.",source:"@site/docs/categories/08-Miscellaneous/eio-protocol.md",sourceDirName:"categories/08-Miscellaneous",slug:"/engine-io-protocol/",permalink:"/docs/v4/engine-io-protocol/",draft:!1,editUrl:"https://github.com/socketio/nhonvo.github.io/edit/main/docs/categories/08-Miscellaneous/eio-protocol.md",tags:[],version:"current",lastUpdatedAt:1679934309,formattedLastUpdatedAt:"Mar 27, 2023",sidebarPosition:3,frontMatter:{title:"The Engine.IO protocol",sidebar_position:3,slug:"/engine-io-protocol/"},sidebar:"sidebar",previous:{title:"Glossary",permalink:"/docs/v4/glossary/"},next:{title:"The Socket.IO protocol",permalink:"/docs/v4/socket-io-protocol/"}},p={},g=[{value:"Introduction",id:"introduction",level:2},{value:"Transports",id:"transports",level:2},{value:"HTTP long-polling",id:"http-long-polling",level:3},{value:"Request path",id:"request-path",level:4},{value:"Query parameters",id:"query-parameters",level:4},{value:"Headers",id:"headers",level:4},{value:"Sending and receiving data",id:"sending-and-receiving-data",level:4},{value:"Sending data",id:"sending-data",level:5},{value:"Receiving data",id:"receiving-data",level:5},{value:"WebSocket",id:"websocket",level:3},{value:"Protocol",id:"protocol",level:2},{value:"Handshake",id:"handshake",level:3},{value:"Heartbeat",id:"heartbeat",level:3},{value:"Upgrade",id:"upgrade",level:3},{value:"Message",id:"message",level:3},{value:"Packet encoding",id:"packet-encoding",level:2},{value:"HTTP long-polling",id:"http-long-polling-1",level:3},{value:"WebSocket",id:"websocket-1",level:3},{value:"History",id:"history",level:2},{value:"From v2 to v3",id:"from-v2-to-v3",level:3},{value:"From v3 to v4",id:"from-v3-to-v4",level:3},{value:"Test suite",id:"test-suite",level:2}],s={toc:g},d="wrapper";function y(e){let{components:n,...t}=e;return(0,r.yg)(d,(0,a.A)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"This document describes the 4th version of the Engine.IO protocol."),(0,r.yg)("p",null,"The source of this document can be found ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/socketio/engine.io-protocol"},"here"),"."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Table of content")),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#introduction"},"Introduction")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#transports"},"Transports"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#http-long-polling"},"HTTP long-polling"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#request-path"},"Request path")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#query-parameters"},"Query parameters")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#headers"},"Headers")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#sending-and-receiving-data"},"Sending and receiving data"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#sending-data"},"Sending data")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#receiving-data"},"Receiving data")))))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#websocket"},"WebSocket")))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#protocol"},"Protocol"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#handshake"},"Handshake")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#heartbeat"},"Heartbeat")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#upgrade"},"Upgrade")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#message"},"Message")))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#packet-encoding"},"Packet encoding"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#http-long-polling-1"},"HTTP long-polling")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#websocket-1"},"WebSocket")))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#history"},"History"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#from-v2-to-v3"},"From v2 to v3")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#from-v3-to-v4"},"From v3 to v4")))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#test-suite"},"Test suite"))),(0,r.yg)("h2",{id:"introduction"},"Introduction"),(0,r.yg)("p",null,"The Engine.IO protocol enables ",(0,r.yg)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Duplex_(telecommunications)#FULL-DUPLEX"},"full-duplex")," and low-overhead communication between a client and a server."),(0,r.yg)("p",null,"It is based on the ",(0,r.yg)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/WebSocket"},"WebSocket protocol")," and uses ",(0,r.yg)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Push_technology#Long_polling"},"HTTP long-polling")," as fallback if the WebSocket connection can't be established."),(0,r.yg)("p",null,"The reference implementation is written in ",(0,r.yg)("a",{parentName:"p",href:"https://www.typescriptlang.org/"},"TypeScript"),":"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"server: ",(0,r.yg)("a",{parentName:"li",href:"https://github.com/socketio/engine.io"},"https://github.com/socketio/engine.io")),(0,r.yg)("li",{parentName:"ul"},"client: ",(0,r.yg)("a",{parentName:"li",href:"https://github.com/socketio/engine.io-client"},"https://github.com/socketio/engine.io-client"))),(0,r.yg)("p",null,"The ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/socketio/socket.io-protocol"},"Socket.IO protocol")," is built on top of these foundations, bringing additional features over the communication channel provided by the Engine.IO protocol."),(0,r.yg)("h2",{id:"transports"},"Transports"),(0,r.yg)("p",null,"The connection between an Engine.IO client and an Engine.IO server can be established with:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#http-long-polling"},"HTTP long-polling")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#websocket"},"WebSocket"))),(0,r.yg)("h3",{id:"http-long-polling"},"HTTP long-polling"),(0,r.yg)("p",null,'The HTTP long-polling transport (also simply referred as "polling") consists of successive HTTP requests:'),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"long-running ",(0,r.yg)("inlineCode",{parentName:"li"},"GET")," requests, for receiving data from the server"),(0,r.yg)("li",{parentName:"ul"},"short-running ",(0,r.yg)("inlineCode",{parentName:"li"},"POST")," requests, for sending data to the server")),(0,r.yg)("h4",{id:"request-path"},"Request path"),(0,r.yg)("p",null,"The path of the HTTP requests is ",(0,r.yg)("inlineCode",{parentName:"p"},"/engine.io/")," by default."),(0,r.yg)("p",null,"It might be updated by libraries built on top of the protocol (for example, the Socket.IO protocol uses ",(0,r.yg)("inlineCode",{parentName:"p"},"/socket.io/"),")."),(0,r.yg)("h4",{id:"query-parameters"},"Query parameters"),(0,r.yg)("p",null,"The following query parameters are used:"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Name"),(0,r.yg)("th",{parentName:"tr",align:null},"Value"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"EIO")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"4")),(0,r.yg)("td",{parentName:"tr",align:null},"Mandatory, the version of the protocol.")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"transport")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"polling")),(0,r.yg)("td",{parentName:"tr",align:null},"Mandatory, the name of the transport.")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"sid")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"<sid>")),(0,r.yg)("td",{parentName:"tr",align:null},"Mandatory once the session is established, the session identifier.")))),(0,r.yg)("p",null,"If a mandatory query parameter is missing, then the server MUST respond with an HTTP 400 error status."),(0,r.yg)("h4",{id:"headers"},"Headers"),(0,r.yg)("p",null,"When sending binary data, the sender (client or server) MUST include a ",(0,r.yg)("inlineCode",{parentName:"p"},"Content-Type: application/octet-stream")," header."),(0,r.yg)("p",null,"Without an explicit ",(0,r.yg)("inlineCode",{parentName:"p"},"Content-Type")," header, the receiver SHOULD infer that the data is plaintext."),(0,r.yg)("p",null,"Reference: ",(0,r.yg)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type"},"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type")),(0,r.yg)("h4",{id:"sending-and-receiving-data"},"Sending and receiving data"),(0,r.yg)("h5",{id:"sending-data"},"Sending data"),(0,r.yg)("p",null,"To send some packets, a client MUST create an HTTP ",(0,r.yg)("inlineCode",{parentName:"p"},"POST")," request with the packets encoded in the request body:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"CLIENT                                                 SERVER\n\n  \u2502                                                      \u2502\n  \u2502   POST /engine.io/?EIO=4&transport=polling&sid=...   \u2502\n  \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502\n  \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n  \u2502                        HTTP 200                      \u2502\n  \u2502                                                      \u2502\n")),(0,r.yg)("p",null,"The server MUST return an HTTP 400 response if the session ID (from the ",(0,r.yg)("inlineCode",{parentName:"p"},"sid")," query parameter) is not known."),(0,r.yg)("p",null,"To indicate success, the server MUST return an HTTP 200 response, with the string ",(0,r.yg)("inlineCode",{parentName:"p"},"ok")," in the response body."),(0,r.yg)("p",null,"To ensure packet ordering, a client MUST NOT have more than one active ",(0,r.yg)("inlineCode",{parentName:"p"},"POST")," request. Should it happen, the server MUST return an HTTP 400 error status and close the session."),(0,r.yg)("h5",{id:"receiving-data"},"Receiving data"),(0,r.yg)("p",null,"To receive some packets, a client MUST create an HTTP ",(0,r.yg)("inlineCode",{parentName:"p"},"GET")," request:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"CLIENT                                                SERVER\n\n  \u2502   GET /engine.io/?EIO=4&transport=polling&sid=...   \u2502\n  \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502\n  \u2502                                                   . \u2502\n  \u2502                                                   . \u2502\n  \u2502                                                   . \u2502\n  \u2502                                                   . \u2502\n  \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n  \u2502                       HTTP 200                      \u2502\n")),(0,r.yg)("p",null,"The server MUST return an HTTP 400 response if the session ID (from the ",(0,r.yg)("inlineCode",{parentName:"p"},"sid")," query parameter) is not known."),(0,r.yg)("p",null,"The server MAY not respond right away if there are no packets buffered for the given session. Once there are some packets to be sent, the server SHOULD encode them (see ",(0,r.yg)("a",{parentName:"p",href:"#packet-encoding"},"Packet encoding"),") and send them in the response body of the HTTP request."),(0,r.yg)("p",null,"To ensure packet ordering, a client MUST NOT have more than one active ",(0,r.yg)("inlineCode",{parentName:"p"},"GET")," request. Should it happen, the server MUST return an HTTP 400 error status and close the session."),(0,r.yg)("h3",{id:"websocket"},"WebSocket"),(0,r.yg)("p",null,"The WebSocket transport consists of a ",(0,r.yg)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API"},"WebSocket connection"),", which provides a bidirectional and low-latency communication channel between the server and the client."),(0,r.yg)("p",null,"The following query parameters are used:"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Name"),(0,r.yg)("th",{parentName:"tr",align:null},"Value"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"EIO")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"4")),(0,r.yg)("td",{parentName:"tr",align:null},"Mandatory, the version of the protocol.")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"transport")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"websocket")),(0,r.yg)("td",{parentName:"tr",align:null},"Mandatory, the name of the transport.")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"sid")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"<sid>")),(0,r.yg)("td",{parentName:"tr",align:null},"Optional, depending on whether it's an upgrade from HTTP long-polling or not.")))),(0,r.yg)("p",null,"If a mandatory query parameter is missing, then the server MUST close the WebSocket connection."),(0,r.yg)("p",null,"Each packet (read or write) is sent its own ",(0,r.yg)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6455#section-5"},"WebSocket frame"),"."),(0,r.yg)("p",null,"A client MUST NOT open more than one WebSocket connection per session. Should it happen, the server MUST close the WebSocket connection."),(0,r.yg)("h2",{id:"protocol"},"Protocol"),(0,r.yg)("p",null,"An Engine.IO packet consists of:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"a packet type"),(0,r.yg)("li",{parentName:"ul"},"an optional packet payload")),(0,r.yg)("p",null,"Here is the list of available packet types:"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Type"),(0,r.yg)("th",{parentName:"tr",align:null},"ID"),(0,r.yg)("th",{parentName:"tr",align:null},"Usage"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"open"),(0,r.yg)("td",{parentName:"tr",align:null},"0"),(0,r.yg)("td",{parentName:"tr",align:null},"Used during the ",(0,r.yg)("a",{parentName:"td",href:"#handshake"},"handshake"),".")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"close"),(0,r.yg)("td",{parentName:"tr",align:null},"1"),(0,r.yg)("td",{parentName:"tr",align:null},"Used to indicate that a transport can be closed.")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"ping"),(0,r.yg)("td",{parentName:"tr",align:null},"2"),(0,r.yg)("td",{parentName:"tr",align:null},"Used in the ",(0,r.yg)("a",{parentName:"td",href:"#heartbeat"},"heartbeat mechanism"),".")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"pong"),(0,r.yg)("td",{parentName:"tr",align:null},"3"),(0,r.yg)("td",{parentName:"tr",align:null},"Used in the ",(0,r.yg)("a",{parentName:"td",href:"#heartbeat"},"heartbeat mechanism"),".")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"message"),(0,r.yg)("td",{parentName:"tr",align:null},"4"),(0,r.yg)("td",{parentName:"tr",align:null},"Used to send a payload to the other side.")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"upgrade"),(0,r.yg)("td",{parentName:"tr",align:null},"5"),(0,r.yg)("td",{parentName:"tr",align:null},"Used during the ",(0,r.yg)("a",{parentName:"td",href:"#upgrade"},"upgrade process"),".")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"noop"),(0,r.yg)("td",{parentName:"tr",align:null},"6"),(0,r.yg)("td",{parentName:"tr",align:null},"Used during the ",(0,r.yg)("a",{parentName:"td",href:"#upgrade"},"upgrade process"),".")))),(0,r.yg)("h3",{id:"handshake"},"Handshake"),(0,r.yg)("p",null,"To establish a connection, the client MUST send an HTTP ",(0,r.yg)("inlineCode",{parentName:"p"},"GET")," request to the server:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"HTTP long-polling first (by default)")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"CLIENT                                                    SERVER\n\n  \u2502                                                          \u2502\n  \u2502        GET /engine.io/?EIO=4&transport=polling           \u2502\n  \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502\n  \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n  \u2502                        HTTP 200                          \u2502\n  \u2502                                                          \u2502\n")),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"WebSocket-only session")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"CLIENT                                                    SERVER\n\n  \u2502                                                          \u2502\n  \u2502        GET /engine.io/?EIO=4&transport=websocket         \u2502\n  \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502\n  \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n  \u2502                        HTTP 101                          \u2502\n  \u2502                                                          \u2502\n")),(0,r.yg)("p",null,"If the server accepts the connection, then it MUST respond with an ",(0,r.yg)("inlineCode",{parentName:"p"},"open")," packet with the following JSON-encoded payload:"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Key"),(0,r.yg)("th",{parentName:"tr",align:null},"Type"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"sid")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"string")),(0,r.yg)("td",{parentName:"tr",align:null},"The session ID.")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"upgrades")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"string[]")),(0,r.yg)("td",{parentName:"tr",align:null},"The list of available ",(0,r.yg)("a",{parentName:"td",href:"#upgrade"},"transport upgrades"),".")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"pingInterval")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"number")),(0,r.yg)("td",{parentName:"tr",align:null},"The ping interval, used in the ",(0,r.yg)("a",{parentName:"td",href:"#heartbeat"},"heartbeat mechanism")," (in milliseconds).")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"pingTimeout")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"number")),(0,r.yg)("td",{parentName:"tr",align:null},"The ping timeout, used in the ",(0,r.yg)("a",{parentName:"td",href:"#heartbeat"},"heartbeat mechanism")," (in milliseconds).")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"maxPayload")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"number")),(0,r.yg)("td",{parentName:"tr",align:null},"The maximum number of bytes per chunk, used by the client to aggregate packets into ",(0,r.yg)("a",{parentName:"td",href:"#packet-encoding"},"payloads"),".")))),(0,r.yg)("p",null,"Example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'{\n  "sid": "lv_VI97HAXpY6yYWAAAC",\n  "upgrades": ["websocket"],\n  "pingInterval": 25000,\n  "pingTimeout": 20000,\n  "maxPayload": 1000000\n}\n')),(0,r.yg)("p",null,"The client MUST send the ",(0,r.yg)("inlineCode",{parentName:"p"},"sid")," value in the query parameters of all subsequent requests."),(0,r.yg)("h3",{id:"heartbeat"},"Heartbeat"),(0,r.yg)("p",null,"Once the ",(0,r.yg)("a",{parentName:"p",href:"#handshake"},"handshake")," is completed, a heartbeat mechanism is started to check the liveness of the connection:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"CLIENT                                                 SERVER\n\n  \u2502                   *** Handshake ***                  \u2502\n  \u2502                                                      \u2502\n  \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n  \u2502                           2                          \u2502  (ping packet)\n  \u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba  \u2502\n  \u2502                           3                          \u2502  (pong packet)\n")),(0,r.yg)("p",null,"At a given interval (the ",(0,r.yg)("inlineCode",{parentName:"p"},"pingInterval")," value sent in the handshake) the server sends a ",(0,r.yg)("inlineCode",{parentName:"p"},"ping")," packet and the client has a few seconds (the ",(0,r.yg)("inlineCode",{parentName:"p"},"pingTimeout")," value) to send a ",(0,r.yg)("inlineCode",{parentName:"p"},"pong")," packet back."),(0,r.yg)("p",null,"If the server does not receive a ",(0,r.yg)("inlineCode",{parentName:"p"},"pong")," packet back, then it SHOULD consider that the connection is closed."),(0,r.yg)("p",null,"Conversely, if the client does not receive a ",(0,r.yg)("inlineCode",{parentName:"p"},"ping")," packet within ",(0,r.yg)("inlineCode",{parentName:"p"},"pingInterval + pingTimeout"),", then it SHOULD consider that the connection is closed."),(0,r.yg)("h3",{id:"upgrade"},"Upgrade"),(0,r.yg)("p",null,"By default, the client SHOULD create an HTTP long-polling connection, and then upgrade to better transports if available."),(0,r.yg)("p",null,"To upgrade to WebSocket, the client MUST:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"pause the HTTP long-polling transport (no more HTTP request gets sent), to ensure that no packet gets lost"),(0,r.yg)("li",{parentName:"ul"},"open a WebSocket connection with the same session ID"),(0,r.yg)("li",{parentName:"ul"},"send a ",(0,r.yg)("inlineCode",{parentName:"li"},"ping")," packet with the string ",(0,r.yg)("inlineCode",{parentName:"li"},"probe")," in the payload")),(0,r.yg)("p",null,"The server MUST:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"send a ",(0,r.yg)("inlineCode",{parentName:"li"},"noop")," packet to any pending ",(0,r.yg)("inlineCode",{parentName:"li"},"GET")," request (if applicable) to cleanly close HTTP long-polling transport"),(0,r.yg)("li",{parentName:"ul"},"respond with a ",(0,r.yg)("inlineCode",{parentName:"li"},"pong")," packet with the string ",(0,r.yg)("inlineCode",{parentName:"li"},"probe")," in the payload")),(0,r.yg)("p",null,"Finally, the client MUST send a ",(0,r.yg)("inlineCode",{parentName:"p"},"upgrade")," packet to complete the upgrade:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"CLIENT                                                 SERVER\n\n  \u2502                                                      \u2502\n  \u2502   GET /engine.io/?EIO=4&transport=websocket&sid=...  \u2502\n  \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502\n  \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n  \u2502            HTTP 101 (WebSocket handshake)            \u2502\n  \u2502                                                      \u2502\n  \u2502            -----  WebSocket frames -----             \u2502\n  \u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba  \u2502\n  \u2502                         2probe                       \u2502 (ping packet)\n  \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n  \u2502                         3probe                       \u2502 (pong packet)\n  \u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba  \u2502\n  \u2502                         5                            \u2502 (upgrade packet)\n  \u2502                                                      \u2502\n")),(0,r.yg)("h3",{id:"message"},"Message"),(0,r.yg)("p",null,"Once the ",(0,r.yg)("a",{parentName:"p",href:"#handshake"},"handshake")," is completed, the client and the server can exchange data by including it in a ",(0,r.yg)("inlineCode",{parentName:"p"},"message")," packet."),(0,r.yg)("h2",{id:"packet-encoding"},"Packet encoding"),(0,r.yg)("p",null,"The serialization of an Engine.IO packet depends on the type of the payload (plaintext or binary) and on the transport."),(0,r.yg)("h3",{id:"http-long-polling-1"},"HTTP long-polling"),(0,r.yg)("p",null,"Due to the nature of the HTTP long-polling transport, multiple packets might be concatenated in a single payload in order to increase throughput."),(0,r.yg)("p",null,"Format:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"<packet type>[<data>]<separator><packet type>[<data>]<separator><packet type>[<data>][...]\n")),(0,r.yg)("p",null,"Example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"4hello\\x1e2\\x1e4world\n\nwith:\n\n4      => message packet type\nhello  => message payload\n\\x1e   => separator\n2      => ping packet type\n\\x1e   => separator\n4      => message packet type\nworld  => message payload\n")),(0,r.yg)("p",null,"The packets are separated by the ",(0,r.yg)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/C0_and_C1_control_codes#Field_separators"},"record separator character"),": ",(0,r.yg)("inlineCode",{parentName:"p"},"\\x1e")),(0,r.yg)("p",null,"Binary payloads MUST be base64-encoded and prefixed with a ",(0,r.yg)("inlineCode",{parentName:"p"},"b")," character:"),(0,r.yg)("p",null,"Example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"4hello\\x1ebAQIDBA==\n\nwith:\n\n4         => message packet type\nhello     => message payload\n\\x1e      => separator\nb         => binary prefix\nAQIDBA==  => buffer <01 02 03 04> encoded as base64\n")),(0,r.yg)("p",null,"The client SHOULD use the ",(0,r.yg)("inlineCode",{parentName:"p"},"maxPayload")," value sent during the ",(0,r.yg)("a",{parentName:"p",href:"#handshake"},"handshake")," to decide how many packets should be concatenated."),(0,r.yg)("h3",{id:"websocket-1"},"WebSocket"),(0,r.yg)("p",null,"Each Engine.IO packet is sent in its own ",(0,r.yg)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6455#section-5"},"WebSocket frame"),"."),(0,r.yg)("p",null,"Format:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"<packet type>[<data>]\n")),(0,r.yg)("p",null,"Example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"4hello\n\nwith:\n\n4      => message packet type\nhello  => message payload (UTF-8 encoded)\n")),(0,r.yg)("p",null,"Binary payloads are sent as is, without modification."),(0,r.yg)("h2",{id:"history"},"History"),(0,r.yg)("h3",{id:"from-v2-to-v3"},"From v2 to v3"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"add support for binary data")),(0,r.yg)("p",null,"The ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/socketio/engine.io-protocol/tree/v2"},"2nd version")," of the protocol is used in Socket.IO ",(0,r.yg)("inlineCode",{parentName:"p"},"v0.9")," and below."),(0,r.yg)("p",null,"The ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/socketio/engine.io-protocol/tree/v3"},"3rd version")," of the protocol is used in Socket.IO ",(0,r.yg)("inlineCode",{parentName:"p"},"v1")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"v2"),"."),(0,r.yg)("h3",{id:"from-v3-to-v4"},"From v3 to v4"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"reverse ping/pong mechanism")),(0,r.yg)("p",null,"The ping packets are now sent by the server, because the timers set in the browsers are not reliable enough. We\nsuspect that a lot of timeout problems came from timers being delayed on the client-side."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"always use base64 when encoding a payload with binary data")),(0,r.yg)("p",null,"This change allows to treat all payloads (with or without binary) the same way, without having to take in account\nwhether the client or the current transport supports binary data or not."),(0,r.yg)("p",null,"Please note that this only applies to HTTP long-polling. Binary data is sent in WebSocket frames with no additional transformation."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"use a record separator (",(0,r.yg)("inlineCode",{parentName:"li"},"\\x1e"),") instead of counting of characters")),(0,r.yg)("p",null,"Counting characters prevented (or at least makes harder) to implement the protocol in other languages, which may not use\nthe UTF-16 encoding."),(0,r.yg)("p",null,"For example, ",(0,r.yg)("inlineCode",{parentName:"p"},"\u20ac")," was encoded to ",(0,r.yg)("inlineCode",{parentName:"p"},"2:4\u20ac"),", though ",(0,r.yg)("inlineCode",{parentName:"p"},"Buffer.byteLength('\u20ac') === 3"),"."),(0,r.yg)("p",null,"Note: this assumes the record separator is not used in the data."),(0,r.yg)("p",null,"The 4th version (current) is included in Socket.IO ",(0,r.yg)("inlineCode",{parentName:"p"},"v3")," and above."),(0,r.yg)("h2",{id:"test-suite"},"Test suite"),(0,r.yg)("p",null,"The test suite in the ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/socketio/engine.io-protocol/tree/main/test-suite"},(0,r.yg)("inlineCode",{parentName:"a"},"test-suite/"))," directory lets you check the compliance of a server implementation."),(0,r.yg)("p",null,"Usage:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"in Node.js: ",(0,r.yg)("inlineCode",{parentName:"li"},"npm ci && npm test")),(0,r.yg)("li",{parentName:"ul"},"in a browser: simply open the ",(0,r.yg)("inlineCode",{parentName:"li"},"index.html")," file in your browser")),(0,r.yg)("p",null,"For reference, here is expected configuration for the JavaScript server to pass all tests:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},'import { listen } from "engine.io";\n\nconst server = listen(3000, {\n  pingInterval: 300,\n  pingTimeout: 200,\n  maxPayload: 1e6,\n  cors: {\n    origin: "*"\n  }\n});\n\nserver.on("connection", socket => {\n  socket.on("data", (...args) => {\n    socket.send(...args);\n  });\n});\n')))}y.isMDXComponent=!0}}]);