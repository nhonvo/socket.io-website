"use strict";(self.webpackChunksample_website=self.webpackChunksample_website||[]).push([[6253],{5680:(e,t,a)=>{a.d(t,{xA:()=>g,yg:()=>c});var n=a(6540);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},g=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},y=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,g=i(e,["components","mdxType","originalType","parentName"]),d=p(a),y=r,c=d["".concat(s,".").concat(y)]||d[y]||m[y]||l;return a?n.createElement(c,o(o({ref:t},g),{},{components:a})):n.createElement(c,o({ref:t},g))}));function c(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,o=new Array(l);o[0]=y;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[d]="string"==typeof e?e:r,o[1]=i;for(var p=2;p<l;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}y.displayName="MDXCreateElement"},9173:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>g,contentTitle:()=>s,default:()=>c,frontMatter:()=>i,metadata:()=>p,toc:()=>d});var n=a(8168),r=(a(6540),a(5680)),l=a(1653),o=a(6025);const i={title:"Postgres adapter",sidebar_position:5,slug:"/postgres-adapter/"},s=void 0,p={unversionedId:"categories/Adapters/adapter-postgres",id:"categories/Adapters/adapter-postgres",title:"Postgres adapter",description:"How it works",source:"@site/docs/categories/05-Adapters/adapter-postgres.md",sourceDirName:"categories/05-Adapters",slug:"/postgres-adapter/",permalink:"/socket.io-website/docs/v4/postgres-adapter/",draft:!1,editUrl:"https://github.com/socketio/socket.io-website/edit/main/docs/categories/05-Adapters/adapter-postgres.md",tags:[],version:"current",lastUpdatedAt:1721260448,formattedLastUpdatedAt:"Jul 17, 2024",sidebarPosition:5,frontMatter:{title:"Postgres adapter",sidebar_position:5,slug:"/postgres-adapter/"},sidebar:"sidebar",previous:{title:"MongoDB adapter",permalink:"/socket.io-website/docs/v4/mongo-adapter/"},next:{title:"Cluster adapter",permalink:"/socket.io-website/docs/v4/cluster-adapter/"}},g={},d=[{value:"How it works",id:"how-it-works",level:2},{value:"Supported features",id:"supported-features",level:2},{value:"Installation",id:"installation",level:2},{value:"Usage",id:"usage",level:2},{value:"Options",id:"options",level:2},{value:"Common questions",id:"common-questions",level:2},{value:"Do I still need to enable sticky sessions when using the Postgres adapter?",id:"do-i-still-need-to-enable-sticky-sessions-when-using-the-postgres-adapter",level:3},{value:"What happens when the Postgres server is down?",id:"what-happens-when-the-postgres-server-is-down",level:3},{value:"Latest releases",id:"latest-releases",level:2},{value:"Emitter",id:"emitter",level:2},{value:"Installation",id:"installation-1",level:3},{value:"Usage",id:"usage-1",level:3},{value:"Latest releases",id:"latest-releases-1",level:3}],m={toc:d},y="wrapper";function c(e){let{components:t,...a}=e;return(0,r.yg)(y,(0,n.A)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("h2",{id:"how-it-works"},"How it works"),(0,r.yg)("p",null,"The Postgres adapter relies on the ",(0,r.yg)("a",{parentName:"p",href:"https://www.postgresql.org/docs/current/sql-notify.html"},"NOTIFY")," and ",(0,r.yg)("a",{parentName:"p",href:"https://www.postgresql.org/docs/current/sql-listen.html"},"LISTEN")," commands."),(0,r.yg)("p",null,"Every packet that is sent to multiple clients (e.g. ",(0,r.yg)("inlineCode",{parentName:"p"},'io.to("room1").emit()')," or ",(0,r.yg)("inlineCode",{parentName:"p"},"socket.broadcast.emit()"),") is:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"sent to all matching clients connected to the current server"),(0,r.yg)("li",{parentName:"ul"},"if the packet contains binary data or is above the 8000 bytes limit, the packet is:",(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"encoded with ",(0,r.yg)("a",{parentName:"li",href:"https://msgpack.org/"},"msgpack")," and inserted in an auxiliary table"),(0,r.yg)("li",{parentName:"ul"},"the row ID is sent within a NOTIFY command"),(0,r.yg)("li",{parentName:"ul"},"this row ID is received by the other Socket.IO servers of the cluster, which query the table, decode the packet and then broadcast it to their own set of connected clients"))),(0,r.yg)("li",{parentName:"ul"},"else, the packet is simply sent within a NOTIFY command and received by the other Socket.IO servers of the cluster")),(0,r.yg)(l.A,{alt:"Diagram of how the Postgres adapter works",sources:{light:(0,o.A)("/images/postgres-adapter.png"),dark:(0,o.A)("/images/postgres-adapter-dark.png")},mdxType:"ThemedImage"}),(0,r.yg)("p",null,"The source code of this adapter can be found ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/socketio/socket.io-postgres-adapter"},"here"),"."),(0,r.yg)("h2",{id:"supported-features"},"Supported features"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Feature"),(0,r.yg)("th",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"th"},"socket.io")," version"),(0,r.yg)("th",{parentName:"tr",align:null},"Support"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Socket management"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"4.0.0")),(0,r.yg)("td",{parentName:"tr",align:null},"\u2705 YES (since version ",(0,r.yg)("inlineCode",{parentName:"td"},"0.1.0"),")")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Inter-server communication"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"4.1.0")),(0,r.yg)("td",{parentName:"tr",align:null},"\u2705 YES (since version ",(0,r.yg)("inlineCode",{parentName:"td"},"0.1.0"),")")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Broadcast with acknowledgements"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"/socket.io-website/docs/v4/changelog/4.5.0"},(0,r.yg)("inlineCode",{parentName:"a"},"4.5.0"))),(0,r.yg)("td",{parentName:"tr",align:null},"\u2705 YES (since version ",(0,r.yg)("inlineCode",{parentName:"td"},"0.3.0"),")")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"Connection state recovery"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"/socket.io-website/docs/v4/changelog/4.6.0"},(0,r.yg)("inlineCode",{parentName:"a"},"4.6.0"))),(0,r.yg)("td",{parentName:"tr",align:null},"\u274c NO")))),(0,r.yg)("h2",{id:"installation"},"Installation"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"npm install @socket.io/postgres-adapter pg\n")),(0,r.yg)("p",null,"For TypeScript users, you might also need ",(0,r.yg)("inlineCode",{parentName:"p"},"@types/pg"),"."),(0,r.yg)("h2",{id:"usage"},"Usage"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},'import { Server } from "socket.io";\nimport { createAdapter } from "@socket.io/postgres-adapter";\nimport pg from "pg";\n\nconst io = new Server();\n\nconst pool = new pg.Pool({\n  user: "postgres",\n  host: "localhost",\n  database: "postgres",\n  password: "changeit",\n  port: 5432,\n});\n\npool.query(`\n  CREATE TABLE IF NOT EXISTS socket_io_attachments (\n      id          bigserial UNIQUE,\n      created_at  timestamptz DEFAULT NOW(),\n      payload     bytea\n  );\n`);\n\npool.on("error", (err) => {\n  console.error("Postgres error", err);\n});\n\nio.adapter(createAdapter(pool));\nio.listen(3000);\n')),(0,r.yg)("h2",{id:"options"},"Options"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Name"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"),(0,r.yg)("th",{parentName:"tr",align:null},"Default value"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"uid")),(0,r.yg)("td",{parentName:"tr",align:null},"the ID of this node"),(0,r.yg)("td",{parentName:"tr",align:null},"a random ID")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"channelPrefix")),(0,r.yg)("td",{parentName:"tr",align:null},"the prefix of the notification channel"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"socket.io"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"tableName")),(0,r.yg)("td",{parentName:"tr",align:null},"the name of the table for payloads over the 8000 bytes limit or containing binary data"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"socket_io_attachments"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"payloadThreshold")),(0,r.yg)("td",{parentName:"tr",align:null},"the threshold for the payload size in bytes"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"8000"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"requestsTimeout")),(0,r.yg)("td",{parentName:"tr",align:null},"the timeout for inter-server requests such as ",(0,r.yg)("inlineCode",{parentName:"td"},"fetchSockets()")," or ",(0,r.yg)("inlineCode",{parentName:"td"},"serverSideEmit()")," with ack"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"5000"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"heartbeatInterval")),(0,r.yg)("td",{parentName:"tr",align:null},"the number of ms between two heartbeats"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"5000"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"heartbeatTimeout")),(0,r.yg)("td",{parentName:"tr",align:null},"the number of ms without heartbeat before we consider a node down"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"10000"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"cleanupInterval")),(0,r.yg)("td",{parentName:"tr",align:null},"the number of ms between two cleanup queries"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"30000"))))),(0,r.yg)("h2",{id:"common-questions"},"Common questions"),(0,r.yg)("h3",{id:"do-i-still-need-to-enable-sticky-sessions-when-using-the-postgres-adapter"},"Do I still need to enable sticky sessions when using the Postgres adapter?"),(0,r.yg)("p",null,"Yes. Failing to do so will result in HTTP 400 responses (you are reaching a server that is not aware of the Socket.IO session)."),(0,r.yg)("p",null,"More information can be found ",(0,r.yg)("a",{parentName:"p",href:"/socket.io-website/docs/v4/using-multiple-nodes/#why-is-sticky-session-required"},"here"),"."),(0,r.yg)("h3",{id:"what-happens-when-the-postgres-server-is-down"},"What happens when the Postgres server is down?"),(0,r.yg)("p",null,"In case the connection to the Postgres server is severed, the packets will only be sent to the clients that are connected to the current server."),(0,r.yg)("h2",{id:"latest-releases"},"Latest releases"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Version"),(0,r.yg)("th",{parentName:"tr",align:null},"Release date"),(0,r.yg)("th",{parentName:"tr",align:null},"Release notes"),(0,r.yg)("th",{parentName:"tr",align:null},"Diff"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"0.4.0")),(0,r.yg)("td",{parentName:"tr",align:null},"July 2024"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/releases/tag/0.4.0"},"link")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/compare/0.3.1...0.4.0"},(0,r.yg)("inlineCode",{parentName:"a"},"0.3.1...0.4.0")))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"0.3.1")),(0,r.yg)("td",{parentName:"tr",align:null},"February 2023"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/releases/tag/0.3.1"},"link")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/compare/0.3.0...0.3.1"},(0,r.yg)("inlineCode",{parentName:"a"},"0.3.0...0.3.1")))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"0.3.0")),(0,r.yg)("td",{parentName:"tr",align:null},"April 2022"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/releases/tag/0.3.0"},"link")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/compare/0.2.0...0.3.0"},(0,r.yg)("inlineCode",{parentName:"a"},"0.2.0...0.3.0")))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"0.2.0")),(0,r.yg)("td",{parentName:"tr",align:null},"December 2021"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/releases/tag/0.2.0"},"link")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/compare/0.1.1...0.2.0"},(0,r.yg)("inlineCode",{parentName:"a"},"0.1.1...0.2.0")))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"0.1.1")),(0,r.yg)("td",{parentName:"tr",align:null},"June 2021"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/releases/tag/0.1.1"},"link")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/compare/0.1.0...0.1.1"},(0,r.yg)("inlineCode",{parentName:"a"},"0.1.0...0.1.1")))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"0.1.0")),(0,r.yg)("td",{parentName:"tr",align:null},"June 2021"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-adapter/releases/tag/0.1.0"},"link")),(0,r.yg)("td",{parentName:"tr",align:null})))),(0,r.yg)("p",null,(0,r.yg)("a",{parentName:"p",href:"https://github.com/socketio/socket.io-postgres-adapter/blob/main/CHANGELOG.md"},"Complete changelog")),(0,r.yg)("h2",{id:"emitter"},"Emitter"),(0,r.yg)("p",null,"The Postgres emitter allows sending packets to the connected clients from another Node.js process:"),(0,r.yg)(l.A,{alt:"Diagram of how the Postgres emitter works",sources:{light:(0,o.A)("/images/postgres-emitter.png"),dark:(0,o.A)("/images/postgres-emitter-dark.png")},mdxType:"ThemedImage"}),(0,r.yg)("h3",{id:"installation-1"},"Installation"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"npm install @socket.io/postgres-emitter pg\n")),(0,r.yg)("h3",{id:"usage-1"},"Usage"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},'const { Emitter } = require("@socket.io/postgres-emitter");\nconst { Pool } = require("pg");\n\nconst pool = new Pool({\n  user: "postgres",\n  host: "localhost",\n  database: "postgres",\n  password: "changeit",\n  port: 5432,\n});\n\nconst emitter = new Emitter(pool);\n\nsetInterval(() => {\n  emitter.emit("ping", new Date());\n}, 1000);\n')),(0,r.yg)("p",null,"Please refer to the cheatsheet ",(0,r.yg)("a",{parentName:"p",href:"/socket.io-website/docs/v4/adapter/#emitter-cheatsheet"},"here"),"."),(0,r.yg)("h3",{id:"latest-releases-1"},"Latest releases"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Version"),(0,r.yg)("th",{parentName:"tr",align:null},"Release date"),(0,r.yg)("th",{parentName:"tr",align:null},"Release notes"),(0,r.yg)("th",{parentName:"tr",align:null},"Diff"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"0.1.0")),(0,r.yg)("td",{parentName:"tr",align:null},"June 2021"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://github.com/socketio/socket.io-postgres-emitter/releases/tag/0.1.0"},"link")),(0,r.yg)("td",{parentName:"tr",align:null})))),(0,r.yg)("p",null,(0,r.yg)("a",{parentName:"p",href:"https://github.com/socketio/socket.io-postgres-emitter/blob/main/CHANGELOG.md"},"Complete changelog")))}c.isMDXComponent=!0}}]);